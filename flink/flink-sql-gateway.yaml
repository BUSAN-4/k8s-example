apiVersion: v1
kind: ConfigMap
metadata:
  name: flink-sql-gateway-config-119
  namespace: flink
data:
  # 이 파일은 SQL Gateway Pod에 마운트됩니다.
  config.yaml: |+
    # =================================================================
    # Flink SQL Gateway 관련 설정
    # =================================================================
    # 세션 타임아웃 설정 (예: 1시간 동안 활동이 없으면 세션 종료)
    sql-gateway.session.idle-timeout: 1h
    # 세션 상태를 주기적으로 체크하는 간격
    sql-gateway.session.check-interval: 1m
    # =================================================================
    # Flink 클러스터 연결 및 일반 설정
    # =================================================================
    sql-gateway.endpoint.rest.address: 0.0.0.0
    sql-gateway.endpoint.rest.port: 8083
    
    jobmanager.rpc.address: flink-cluster-119-rest.flink-cluster-119.svc.cluster.local
    jobmanager.rpc.port: 6123
    
    env.hadoop.conf.dir: "/hadoop/etc/hadoop"
    fs.s3a.impl.disable.cache: "true"
    classloader.parent-first-patterns.defaults: 'java.;scala.;org.apache.flink.;org.apache.kafka.;org.apache.hadoop.;software.amazon.;org.apache.iceberg.;org.apache.parquet.'

  # log4j-console.properties: |
  #   rootLogger.level=INFO
  #   rootLogger.appenderRef.console.ref=ConsoleAppender
  #   # ================================================================
  #   # S3A 파일시스템 및 AWS SDK 디버그 로깅 활성화 (가장 중요)
  #   # ================================================================
  #   logger.s3a.name=org.apache.hadoop.fs.s3a
  #   logger.s3a.level=DEBUG
  #   logger.awssdk.name=com.amazonaws
  #   logger.awssdk.level=DEBUG
  #   # ================================================================
  #   logger.flink.name=org.apache.flink
  #   logger.flink.level=INFO
  #   logger.kafka.name=org.apache.kafka
  #   logger.kafka.level=WARN
  #   logger.hadoop.name=org.apache.hadoop
  #   logger.hadoop.level=WARN
  #   logger.iceberg.name=org.apache.iceberg
  #   logger.iceberg.level=INFO
  #   appender.console.name=ConsoleAppender
  #   appender.console.type=CONSOLE
  #   appender.console.layout.type=PatternLayout
  #   appender.console.layout.pattern=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: flink-sql-gateway-119
  namespace: flink
spec:
  replicas: 1
  selector:
    matchLabels:
      app: flink-sql-gateway-119
  template:
    metadata:
      labels:
        app: flink-sql-gateway-119
    spec:
      initContainers:
        # - name: python-init
        #   image: python:3.10.12-slim
        #   command:
        #     - /bin/sh
        #     - -c
        #     - |
        #       pip3 install apache-flink==1.19.3

        #       mkdir -p /python/link/bin
        #       mkdir -p /python/link/lib

        #       cp -r /usr/local/bin/* /python/link/bin/
        #       cp -r /usr/local/lib/* /python/link/lib/

        #   volumeMounts:
        #     - name: flink-python-bin-volume
        #       mountPath: /python/link/bin
        #     - name: flink-python-lib-volume
        #       mountPath: /python/link/lib
        - name: flink-lib-init
          image: flink:1.19.3-scala_2.12-java11
          command:
            - /bin/sh
            - -c
            - |
              cp -r /opt/flink/lib/* /flink-libs
              rm -rf /flink-libs/flink-shaded-hadoop-2-uber*
              cp -r /opt/flink/plugins/* /flink-plugins
              
              # cp -r /usr/local/bin/* /python/link/bin

          volumeMounts:
            - name: flink-lib-volume
              mountPath: /flink-libs
            - name: flink-plugin-volume
              mountPath: /flink-plugins
            # - name: flink-python-bin-volume
            #   mountPath: /python/link/bin
            # - name: flink-python-lib-volume
            #   mountPath: /python/link/lib
        - name: dependency-downloader
          image: apache/hadoop:3.3.5
          command:
            - /bin/sh
            - -c
            - |
              
              cp -r /opt/hadoop/* /hadoop
              
              cd /flink-libs
              
              # JDBC 접근 세팅
              wget https://repo1.maven.org/maven2/org/apache/flink/flink-connector-jdbc/3.3.0-1.19/flink-connector-jdbc-3.3.0-1.19.jar
              wget https://repo.maven.apache.org/maven2/mysql/mysql-connector-java/8.0.11/mysql-connector-java-8.0.11.jargithuGITGIT

              # mkdir -p /flink-plugins/jdbc
              # wget -P /flink-plugins/jdbc https://repo.maven.apache.org/maven2/mysql/mysql-connector-java/8.0.11/mysql-connector-java-8.0.11.jar
              # wget -P /flink-plugins/jdbc https://repo1.maven.org/maven2/org/apache/flink/flink-connector-jdbc/3.3.0-1.19/flink-connector-jdbc-3.3.0-1.19.jar

              # Kafka 세팅
              wget https://repo1.maven.org/maven2/org/apache/flink/flink-sql-connector-kafka/3.3.0-1.19/flink-sql-connector-kafka-3.3.0-1.19.jar
              wget https://repo1.maven.org/maven2/org/apache/kafka/kafka-clients/3.3.0/kafka-clients-3.3.0.jar
              wget https://repo1.maven.org/maven2/org/apache/flink/flink-avro/1.19.3/flink-avro-1.19.3.jar
              wget https://repo1.maven.org/maven2/org/apache/flink/flink-avro-confluent-registry/1.19.3/flink-avro-confluent-registry-1.19.3.jar
              wget https://packages.confluent.io/maven/io/confluent/kafka-schema-registry-client/7.0.16/kafka-schema-registry-client-7.0.16.jar
              wget https://repo1.maven.org/maven2/org/apache/avro/avro/1.10.2/avro-1.10.2.jar
              wget https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-databind/2.13.5/jackson-databind-2.13.5.jar
              wget https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-core/2.13.5/jackson-core-2.13.5.jar
              wget https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-annotations/2.13.5/jackson-annotations-2.13.5.jar
              
              # hadoop 3.3.5 세팅
              cp /hadoop/share/hadoop/common/hadoop-common-3.3.5.jar /flink-libs
              cp /hadoop/share/hadoop/common/lib/commons-configuration2-2.8.0.jar /flink-libs
              cp /hadoop/share/hadoop/common/lib/stax2-api-4.2.1.jar /flink-libs
              cp /hadoop/share/hadoop/common/lib/commons-logging-1.1.3.jar /flink-libs
              cp /hadoop/share/hadoop/common/lib/hadoop-shaded-guava-1.1.1.jar /flink-libs
              cp /hadoop/share/hadoop/common/lib/hadoop-auth-3.3.5.jar /flink-libs
              cp /hadoop/share/hadoop/common/lib/woodstox-core-5.4.0.jar /flink-libs
              cp /hadoop/share/hadoop/hdfs/hadoop-hdfs-client-3.3.5.jar /flink-libs
              cp /hadoop/share/hadoop/mapreduce/hadoop-mapreduce-client-core-3.3.5.jar /flink-libs
              wget https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-aws/3.3.5/hadoop-aws-3.3.5.jar

          volumeMounts:
            - name: flink-lib-volume
              mountPath: /flink-libs
            - name: flink-plugin-volume
              mountPath: /flink-plugins
            - name: hadoop
              mountPath: /hadoop
      containers:
      - name: sql-gateway
        env:
          - name: TZ
            value: Asia/Seoul
          - name: HADOOP_HOME
            value: /hadoop
          - name: FLINK_ENV_JAVA_OPTS
            value: "-Djdbc.drivers=com.mysql.cj.jdbc.Driver"
          - name: HADOOP_CLASSPATH
            value: /hadoop/etc/hadoop:/hadoop/share/hadoop/common/lib/*:/hadoop/share/hadoop/common/*:/hadoop/share/hadoop/hdfs:/hadoop/share/hadoop/hdfs/lib/*:/hadoop/share/hadoop/hdfs/*:/hadoop/share/hadoop/mapreduce/*:/hadoop/share/hadoop/yarn:/hadoop/share/hadoop/yarn/lib/*:/hadoop/share/hadoop/yarn/*
        image: flink:1.19.3-scala_2.12-java11
        command: ["/opt/flink/bin/sql-gateway.sh", "start-foreground"]
        ports:
        - containerPort: 8083
          name: sql-gateway
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1"
        volumeMounts:
        - name: hadoop
          mountPath: /hadoop
        - name: flink-lib-volume
          mountPath: /opt/flink/lib
        - name: flink-plugin-volume
          mountPath: /opt/flink/plugins
        - name: flink-config-volume-119
          mountPath: /opt/flink/conf/config.yaml
          subPath: config.yaml
        # - name: flink-config-volume-119
        #   mountPath: /opt/flink/conf/log4j-console.properties
        #   subPath: log4j-console.properties
      volumes:
      - name: flink-config-volume-119
        configMap:
          name: flink-sql-gateway-config-119
      - name: flink-plugin-volume
        emptyDir: { }
      - name: flink-lib-volume
        emptyDir: { }
      # - name: flink-python-bin-volume
      #   emptyDir: { }
      # - name: flink-python-lib-volume
      #   emptyDir: { }
      - name: hadoop
        emptyDir: { }
---
apiVersion: v1
kind: Service
metadata:
  name: sql-gateway-service-119 
  namespace: flink
spec:
  selector:
    app: flink-sql-gateway-119
  ports:
  - name: sql-gateway
    port: 8083
    targetPort: 8083
    nodePort: 30110
  type: NodePort
